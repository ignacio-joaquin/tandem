<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="flex justify-center bg-[#d4dbdc] min-h-screen flex-col">

    <div class="w-full max-w-lg p-6 rounded-lg">
        <h1 class="text-2xl font-bold text-center mb-6">My Goals</h1>

        <!-- Button to Add New Goal -->
        <div class="flex justify-end mb-4">
            <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm" id="add-goal">
                + Add Goal
            </button>
        </div>

        <!-- Goal List -->
        <div id="goals-list" class="space-y-6 mb-16"></div>
    </div>

    <!-- Navigation Bar -->
    <nav class="bg-blue-600 p-4 shadow-md fixed bottom-0 left-0 w-full">
        <div class="flex items-center justify-center w-full" style="gap: 33.33%;">
            <a href="friends.html">
                <img src="./media/friends-svgrepo-com.svg" alt="Friends"
                    class="w-8 h-8 hover:opacity-80 transition-all">
            </a>
            <a href="goals.html">
                <img src="media/goal-svgrepo-com.svg" alt="Goals" class="w-8 h-8 hover:opacity-80 transition-all">
            </a>
            <a href="account.html">
                <img src="media/user-circle-svgrepo-com.svg" alt="Account"
                    class="w-8 h-8 hover:opacity-80 transition-all">
            </a>
        </div>
    </nav>
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center">
        <div class="bg-white p-6 rounded-lg shadow-lg w-80">
            <h2 class="text-lg font-bold text-center mb-4">Confirm Deletion</h2>
            <p class="text-sm text-gray-600 text-center mb-6">Are you sure you want to delete this goal?</p>
            <div class="flex justify-between">
                <button id="cancel-delete"
                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Cancel</button>
                <button id="confirm-delete"
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>


    <!-- Modal for Adding a Goal -->
    <div id="add-goal-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center">
        <div class="bg-white p-6 rounded-lg shadow-lg w-80">
            <h2 class="text-lg font-bold text-center mb-4">Add New Goal</h2>
            <form id="goal-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Title</label>
                    <input type="text" id="goal-title" class="w-full px-3 py-2 border rounded-md" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Type</label>
                    <select id="goal-type" class="w-full px-3 py-2 border rounded-md">
                        <option value="Daily">Daily</option>
                        <option value="Weekly">Weekly</option>
                        <option value="Monthly">Monthly</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Deadline</label>
                    <input type="datetime-local" id="goal-deadline" class="w-full px-3 py-2 border rounded-md" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Friend ID</label>
                    <input type="text" id="goal-friend-id" class="w-full px-3 py-2 border rounded-md" required>
                </div>
            </form>
            <div class="mt-4 flex justify-between">
                <button id="cancel-add-goal"
                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Cancel</button>
                <button id="submit-add-goal" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add
                    Goal</button>
            </div>
        </div>
    </div>

    <div id="upload-evidence-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center">
        <div class="bg-white p-6 rounded-lg shadow-lg w-80">
            <h2 class="text-lg font-bold text-center mb-4">Submit Verification Evidence</h2>
            <form id="upload-evidence-form">
                <input type="file" id="verification-evidence" class="w-full px-3 py-2 border rounded-md mb-4" required>
            </form>
            <div class="flex justify-between">
                <button id="cancel-upload-evidence"
                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Cancel</button>
                <button id="submit-upload-evidence"
                    class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">Submit</button>
            </div>
        </div>
    </div>

    <script>
        const goalsList = document.getElementById("goals-list");
        const confirmModal = document.getElementById("confirm-modal");
        const confirmDeleteButton = document.getElementById("confirm-delete");
        const cancelDeleteButton = document.getElementById("cancel-delete");

        let goalToDeleteId = null; // Store the ID of the goal to delete

        // Fetch all goals
        // Fetch goals and update UI
        async function fetchGoals() {
            try {
                const response = await fetch('http://localhost:5000/goals', { credentials: 'include' });
                if (!response.ok) throw new Error("Failed to fetch goals");
                const data = await response.json();
                renderGoals(data);
            } catch (error) {
                console.error(error.message);
            }
        }

        function renderGoals(goals) {
            const goalsList = document.getElementById("goals-list");
            goalsList.innerHTML = ""; // Clear previous goals
            goals.forEach(goal => {
                const goalItem = document.createElement("div");

                // Apply styles based on the verification status
                goalItem.className = `p-4 rounded-lg shadow-md ${goal.verified ? 'bg-green-100 border-green-500 border-l-4' : 'bg-red-100 border-red-500 border-l-4'
                    }`;
                goalItem.innerHTML = `
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-bold ${goal.verified ? 'text-green-700' : 'text-red-700'
                    }">${goal.type}: ${goal.title}</h2>
                <span class="text-sm font-medium flex items-center">
                    ${goal.verified
                        ? `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-5 h-5 text-green-600 mr-2" viewBox="0 0 20 20">
                                <path d="M16.707 5.293a1 1 0 010 1.414L8 15.414l-4.707-4.707a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path>
                               </svg> Completed`
                        : `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-5 h-5 text-red-600 mr-2" viewBox="0 0 20 20">
                                <path d="M9 2a7 7 0 100 14 7 7 0 000-14zM7.707 9l-2-2a1 1 0 011.414-1.414L9 7.586l2.293-2.293a1 1 0 011.414 1.414l-2 2 2 2a1 1 0 01-1.414 1.414L9 10.414l-2.293 2.293A1 1 0 015.293 11.293l2-2z"></path>
                               </svg> Pending`
                    }
                </span>
            </div>
            <p class="text-sm text-gray-600">Friend: ${goal.friend.username}</p>
            <p class="text-sm text-gray-600">Deadline: ${new Date(goal.deadline).toLocaleString()}</p>
                    <div class="mt-4 flex justify-between items-center">
                        <button
                            class="${goal.verified ? "hidden" : ""} px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm verify-goal" data-id="${goal.id}">
                            Verify
                        </button>
                        <button
                            class="px-2 py-1 text-sm text-gray-500 hover:text-red-600 focus:outline-none delete-goal" data-id="${goal.id}">
                            Delete
                        </button>
                    </div>
        `;
                goalsList.appendChild(goalItem);
            });

            // Re-attach the event listeners for the verify button
            document.querySelectorAll('.verify-goal').forEach(button => {
                button.addEventListener('click', (e) => {
                    const goalId = e.target.getAttribute('data-id');
                    document.getElementById("upload-evidence-modal").classList.remove("hidden");
                    document.getElementById("submit-upload-evidence").setAttribute("data-id", goalId);
                });
            });
            // Attach event listeners for delete and verify buttons
            document.querySelectorAll('.delete-goal').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    openConfirmModal(id);
                });
            });
        }



        document.querySelectorAll('.verify-goal').forEach(button => {
            button.addEventListener('click', (e) => {
                const id = e.target.getAttribute('data-id');
                verifyGoal(id);
            });
        });

        // Open confirmation modal
        function openConfirmModal(id) {
            goalToDeleteId = id; // Store the goal ID to delete
            confirmModal.classList.remove("hidden");
        }

        // Close confirmation modal
        function closeConfirmModal() {
            goalToDeleteId = null; // Reset the goal ID
            confirmModal.classList.add("hidden");
        }

        // Delete a goal
        async function deleteGoal() {
            if (goalToDeleteId !== null) {
                try {
                    const response = await fetch(`http://localhost:5000/goals/${goalToDeleteId}`, { method: 'DELETE', credentials: "include" });
                    if (!response.ok) throw new Error("Failed to delete goal");
                    fetchGoals(); // Re-fetch goals after deletion
                    closeConfirmModal();
                } catch (error) {
                    console.error(error.message);
                }
            }
        }

        // Verify a goal
        async function verifyGoal(id) {
            try {
                const response = await fetch(`http:localhost:5000/goals/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ verified: true }),
                });
                if (!response.ok) throw new Error("Failed to verify goal");
                fetchGoals(); // Re-fetch goals after verification
            } catch (error) {
                console.error(error.message);
            }
        }

        // Add a new goal
        document.getElementById("add-goal").addEventListener("click", () => {
            document.getElementById("add-goal-modal").classList.remove("hidden");
        });

        document.getElementById("cancel-add-goal").addEventListener("click", () => {
            document.getElementById("add-goal-modal").classList.add("hidden");
        });

        document.getElementById("submit-add-goal").addEventListener("click", async () => {
            const title = document.getElementById("goal-title").value;
            const type = document.getElementById("goal-type").value;
            const deadline = document.getElementById("goal-deadline").value;
            const friendUsername = document.getElementById("goal-friend-id").value;

            if (!title || !type || !deadline || !friendUsername) {
                alert("All fields are required!");
                return;
            }

            const newGoal = { title, type, deadline, friendUsername };

            try {
                const response = await fetch("http://localhost:5000/goals", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify(newGoal),
                });

                if (!response.ok) throw new Error("Failed to add goal");

                document.getElementById("add-goal-modal").classList.add("hidden");
                fetchGoals(); // Re-fetch goals after addition
            } catch (error) {
                console.error(error.message);
                alert("Error adding goal. Please try again.");
            }
        });


        // Add event listeners to modal buttons
        confirmDeleteButton.addEventListener("click", deleteGoal);
        cancelDeleteButton.addEventListener("click", closeConfirmModal);

        // Event Listener for Verify Button (Submit Evidence)
        document.querySelectorAll('.verify-goal').forEach(button => {
            button.addEventListener('click', (e) => {
                const goalId = e.target.getAttribute('data-id');
                // Open the modal when "Verify" button is clicked
                document.getElementById("upload-evidence-modal").classList.remove("hidden");
                document.getElementById("submit-upload-evidence").setAttribute("data-id", goalId);
            });
        });

        // Event Listener for Cancel Upload Evidence
        document.getElementById("cancel-upload-evidence").addEventListener("click", () => {
            document.getElementById("upload-evidence-modal").classList.add("hidden");
        });

        // Event Listener for Submit Upload Evidence
        document.getElementById("submit-upload-evidence").addEventListener("click", async (e) => {
            const goalId = e.target.getAttribute('data-id');
            const evidenceInput = document.getElementById("verification-evidence");

            if (!evidenceInput.files[0]) {
                alert("Please upload a file.");
                return;
            }

            const formData = new FormData();
            formData.append('evidence', evidenceInput.files[0]);

            try {
                // Send the evidence to the backend for verification
                const response = await fetch(`http://localhost:5000/verify/${goalId}/`, {
                    method: 'POST',
                    body: formData,
                    credentials: "include",
                });

                if (!response.ok) {
                    throw new Error("Failed to submit evidence");
                }

                // Close the modal
                document.getElementById("upload-evidence-modal").classList.add("hidden");

                // Optionally, re-fetch and render the goals to show the updated verification status
                fetchGoals();

            } catch (error) {
                console.error(error.message);
                alert("Error submitting verification evidence. Please try again.");
            }
        });


        // Fetch and render goals on load
        fetchGoals();
    </script>

</body>

</html>