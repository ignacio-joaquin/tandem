<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .sk-chase {
        width: 40px;
        height: 40px;
        position: relative;
        animation: sk-chase 2.5s infinite linear both;
      }

      .sk-chase-dot {
        width: 100%;
        height: 100%;
        position: absolute;
        left: 0;
        top: 0;
        animation: sk-chase-dot 2s infinite ease-in-out both;
      }

      .sk-chase-dot:before {
        content: "";
        display: block;
        width: 25%;
        height: 25%;
        background-color: #fff;
        border-radius: 100%;
        animation: sk-chase-dot-before 2s infinite ease-in-out both;
      }

      .sk-chase-dot:nth-child(1) {
        animation-delay: -1.1s;
      }

      .sk-chase-dot:nth-child(2) {
        animation-delay: -1s;
      }

      .sk-chase-dot:nth-child(3) {
        animation-delay: -0.9s;
      }

      .sk-chase-dot:nth-child(4) {
        animation-delay: -0.8s;
      }

      .sk-chase-dot:nth-child(5) {
        animation-delay: -0.7s;
      }

      .sk-chase-dot:nth-child(6) {
        animation-delay: -0.6s;
      }

      .sk-chase-dot:nth-child(1):before {
        animation-delay: -1.1s;
      }

      .sk-chase-dot:nth-child(2):before {
        animation-delay: -1s;
      }

      .sk-chase-dot:nth-child(3):before {
        animation-delay: -0.9s;
      }

      .sk-chase-dot:nth-child(4):before {
        animation-delay: -0.8s;
      }

      .sk-chase-dot:nth-child(5):before {
        animation-delay: -0.7s;
      }

      .sk-chase-dot:nth-child(6):before {
        animation-delay: -0.6s;
      }

      @keyframes sk-chase {
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes sk-chase-dot {
        80%,
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes sk-chase-dot-before {
        50% {
          transform: scale(0.4);
        }

        100%,
        0% {
          transform: scale(1);
        }
      }
    </style>
  </head>

  <body
    class="flex justify-center min-h-screen bg-[#1a2332] font-roboto items-center mx-5"
  >
    <div class="w-full max-w-sm p-6 rounded-lg bg-[#2a3b4c] shadow-lg my-20">
      <div class="p-6 mb-16">
        <div class="w-full justify-center flex">
          <img
            src="../media/friends-svgrepo-com.svg"
            width="150"
            class="mb-4 filter neon-green"
          />
        </div>

        <h1 id="friends-title" class="text-2xl font-bold text-center mb-6 text-[#00ff9c]">
          Friends
        </h1>

        <!-- Online Friends -->
        <div id="friends-online" class="mb-6">
          <h2 id="friends-online-label" class="text-lg font-medium mb-3 text-[#d4dbdc]">
            Friends Online
          </h2>
          <ul class="space-y-3" id="friends-list">
            <!-- Friends will be dynamically added here -->
          </ul>
          <p id="no-friends-message" class="text-center text-[#d4dbdc] hidden">
            You have no friends online.
          </p>
        </div>

        <!-- Friend Requests -->
        <div id="friend-requests" class="mb-6">
          <h2 id="friend-requests-label" class="text-lg font-medium mb-3 text-[#d4dbdc]">
            Friend Requests
          </h2>
          <ul class="space-y-3" id="requests-list">
            <!-- Requests will be dynamically added here -->
          </ul>
          <p id="no-requests-message" class="text-center text-[#d4dbdc] hidden">
            You have no friend requests.
          </p>
        </div>

        <!-- Add Friend -->
        <div>
          <h2 id="add-friend-label" class="text-lg font-medium mb-3 text-[#d4dbdc]">Add a Friend</h2>
          <div class="flex items-center space-x-2">
            <input
              type="text"
              id="friend-input"
              placeholder="Enter username"
              class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring focus:border-blue-500 bg-[#1a2332] text-white"
            />
            <button
              id="send-request"
              class="px-3 py-2 bg-[#00ff9c] text-[#1a2332] text-sm rounded-lg hover:bg-[#00e68a]"
            >
              Send
            </button>
          </div>
        </div>
      </div>

      <!-- Navigation Bar -->
      <nav class="bg-[#2a3b4c] p-4 shadow-md fixed bottom-0 left-0 w-full">
        <div
          class="flex items-center justify-center w-full"
          style="gap: 33.33%"
        >
          <a href="/protected/amigo.html">
            <img
              src="./../media/friends-svgrepo-com.svg"
              alt="Friends"
              class="w-8 h-8 hover:opacity-80 transition-all filter neon-green"
            />
          </a>
          <a href="/protected/goals.html">
            <img
              src="../media/goal-svgrepo-com.svg"
              alt="Goals"
              class="w-8 h-8 hover:opacity-80 transition-all filter neon-green"
            />
          </a>
          <a href="account.html">
            <img
              src="../media/user-circle-svgrepo-com.svg"
              alt="Account"
              class="w-8 h-8 hover:opacity-80 transition-all filter neon-green"
            />
          </a>
        </div>
      </nav>
    </div>

    <!-- Modal -->
    <div
      id="modal"
      class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden"
    >
      <div class="bg-[#2a3b4c] p-6 rounded-lg shadow-lg max-w-sm w-full">
        <h2
          id="modal-title"
          class="text-lg font-medium mb-3 text-[#d4dbdc]"
        ></h2>
        <p id="modal-message" class="text-[#d4dbdc] mb-6"></p>
        <div class="flex justify-end">
          <button
            id="modal-close"
            class="px-3 py-2 bg-[#00ff9c] text-[#1a2332] text-sm rounded-lg hover:bg-[#00e68a]"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <div
      id="loading-spinner"
      class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center"
    >
      <div class="sk-chase">
        <div class="sk-chase-dot"></div>
        <div class="sk-chase-dot"></div>
        <div class="sk-chase-dot"></div>
        <div class="sk-chase-dot"></div>
        <div class="sk-chase-dot"></div>
        <div class="sk-chase-dot"></div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        showLoadingSpinner();
        await fetchFriends();
        await fetchFriendRequests();
        hideLoadingSpinner();
      });

      async function fetchProfilePic(friendId) {
        try {
          const response = await fetch(`/account/profile-pic/${friendId}`);
          if (response.status === 404) {
            return "../media/user-circle-svgrepo-com.svg";
          }
          const data = await response.blob();
          return URL.createObjectURL(data);
        } catch (error) {
          return "../media/user-circle-svgrepo-com.svg";
        }
      }

      // API Base URL
      const API_BASE_URL = "/api/friends";

      // Modal Elements
      const modal = document.getElementById("modal");
      const modalTitle = document.getElementById("modal-title");
      const modalMessage = document.getElementById("modal-message");
      const modalClose = document.getElementById("modal-close");
      const loadingSpinner = document.getElementById("loading-spinner");

      // Show Modal
      function showModal(title, message) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modal.classList.remove("hidden");
      }

      // Close Modal
      modalClose.addEventListener("click", () => {
        modal.classList.add("hidden");
      });

      // Show Loading Spinner
      function showLoadingSpinner() {
        loadingSpinner.classList.remove("hidden");
      }

      // Hide Loading Spinner
      function hideLoadingSpinner() {
        loadingSpinner.classList.add("hidden");
      }

      // Populate Online Friends
      async function fetchFriends() {
        const friendsList = document.getElementById("friends-list");
        const noFriendsMessage = document.getElementById("no-friends-message");
        friendsList.innerHTML = ""; // Clear the list before populating

        showLoadingSpinner();
        try {
          const response = await fetch(`${API_BASE_URL}`, {
            credentials: "include",
          });
          const data = await response.json();

          if (response.ok) {
            if (data.friends.length === 0) {
              noFriendsMessage.classList.remove("hidden");
            } else {
              noFriendsMessage.classList.add("hidden");
              data.friends.forEach(async (friend) => {
                const profilepic = await fetchProfilePic(friend.id);
                const li = document.createElement("li");

                li.className =
                  "flex items-center justify-between p-3 bg-[#1a2332] rounded-lg shadow";
                li.innerHTML = `
                              <div class="flex items-center">
          <img src="${profilepic}" alt="${friend.username} Avatar" class="w-8 h-8 mr-3 rounded-full" id="friend-avatar-${friend.username}">
                                  <span class="text-white">${friend.username}</span>
                              </div>
                              <div class="flex items-center space-x-2">
                                  <button class="px-2 py-1 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 remove-friend" data-id="${friend.username}">
                                      Remove
                                  </button>
                              </div>
                          `;
                friendsList.appendChild(li);
              });

              // Attach event listeners for remove buttons
              document.querySelectorAll(".remove-friend").forEach((button) => {
                button.addEventListener("click", async (e) => {
                  const username = e.target.getAttribute("data-id");
                  await removeFriend(username);
                });
              });
            }
          } else {
            showModal("Error", "Failed to fetch friends: " + data.message);
          }
        } catch (error) {
          showModal("Error", "Error fetching friends: " + error.message);
        } finally {
          hideLoadingSpinner();
        }
      }

      // Populate Friend Requests
      async function fetchFriendRequests() {
        const requestsList = document.getElementById("requests-list");
        const noRequestsMessage = document.getElementById(
          "no-requests-message"
        );
        requestsList.innerHTML = ""; // Clear the list before populating

        showLoadingSpinner();
        try {
          const response = await fetch(`${API_BASE_URL}/incoming`, {
            credentials: "include",
          });
          const data = await response.json();

          if (response.ok) {
            if (data.requests.length === 0) {
              noRequestsMessage.classList.remove("hidden");
            } else {
              noRequestsMessage.classList.add("hidden");
              data.requests.forEach((request) => {
                const li = document.createElement("li");
                li.className =
                  "flex items-center justify-between p-3 bg-[#1a2332] rounded-lg shadow";
                li.innerHTML = `
                              <div class="flex items-center">
                                  <img src="../media/user2.svg" alt="${request.senderUsername} Avatar" class="w-8 h-8 mr-3">
                                  <span class="text-white">${request.senderUsername}</span>
                              </div>
                              <div class="flex space-x-2">
                                  <button class="px-3 py-1 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700"
                                      onclick="respondToRequest(${request.id}, 'accept')">Accept</button>
                                  <button class="px-3 py-1 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700"
                                      onclick="respondToRequest(${request.id}, 'reject')">Decline</button>
                              </div>
                          `;
                requestsList.appendChild(li);
              });
            }
          } else {
            showModal(
              "Error",
              "Failed to fetch friend requests: " + data.message
            );
          }
        } catch (error) {
          showModal(
            "Error",
            "Error fetching friend requests: " + error.message
          );
        } finally {
          hideLoadingSpinner();
        }
      }

      // Respond to a Friend Request
      async function respondToRequest(requestId, action) {
        showLoadingSpinner();
        try {
          const response = await fetch(`${API_BASE_URL}/respond`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
            body: JSON.stringify({ senderId: requestId, action }),
          });

          const data = await response.json();

          if (response.ok) {
            await fetchFriendRequests(); // Refresh friend requests
            await fetchFriends(); // Refresh friends list if accepted
          } else {
            showModal(
              "Error",
              `Failed to ${action} friend request: ` + data.message
            );
          }
        } catch (error) {
          showModal(
            "Error",
            `Error responding to friend request: ` + error.message
          );
        } finally {
          hideLoadingSpinner();
        }
      }

      // Add Friend
      document
        .getElementById("send-request")
        .addEventListener("click", async () => {
          const input = document.getElementById("friend-input");
          const username = input.value.trim();

          if (username) {
            showLoadingSpinner();
            try {
              const response = await fetch(`${API_BASE_URL}/add`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                credentials: "include",
                body: JSON.stringify({ receiverUsername: username }), // Assuming receiverId is a username
              });

              const data = await response.json();

              if (response.ok) {
                input.value = ""; // Clear the input field
                showModal("Success", "Friend request sent successfully!");
              } else {
                showModal(
                  "Error",
                  "Failed to send friend request: " + data.message
                );
              }
            } catch (error) {
              showModal(
                "Error",
                "Error sending friend request: " + error.message
              );
            } finally {
              hideLoadingSpinner();
            }
          } else {
            showModal("Warning", "Please enter a username.");
          }
        });

      // Remove Friend
      async function removeFriend(username) {
        showLoadingSpinner();
        try {
          const response = await fetch(`${API_BASE_URL}/remove`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
            body: JSON.stringify({ username }),
          });

          const data = await response.json();

          if (response.ok) {
            await fetchFriends(); // Refresh friends list
          } else {
            showModal("Error", "Failed to remove friend: " + data.message);
          }
        } catch (error) {
          showModal("Error", "Error removing friend: " + error.message);
        } finally {
          hideLoadingSpinner();
        }
      }

      let translations = {};

      async function loadTranslations(lang) {
        try {
          const response = await fetch(`/locales/${lang}.json`);
          translations = await response.json();
          updateTextContent();
        } catch (error) {
          console.error("Failed to load translations:", error);
        }
      }

      function updateTextContent() {
        document.getElementById("friends-title").textContent = translations.friends;
        document.getElementById("friends-online-label").textContent = translations.friends_online;
        document.getElementById("friend-requests-label").textContent = translations.friend_requests;
        document.getElementById("add-friend-label").textContent = translations.add_friend;
        document.getElementById("send-request").textContent = translations.send;
        document.getElementById("no-friends-message").textContent = translations.no_friends_online;
        document.getElementById("no-requests-message").textContent = translations.no_friend_requests;
      }

      document.addEventListener("DOMContentLoaded", () => {
        const userLang = navigator.language || navigator.userLanguage;
        const lang = userLang.startsWith("es") ? "es" : "en";
        loadTranslations(lang);
      });
    </script>
  </body>
</html>
